<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8 />
      <title>Geo located places from Wikipedia</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.css' rel='stylesheet' />
    <style>
      body { margin:0; padding:0; }
      #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
  </head>
  <body>
    <div id='map'></div>

    <!-- jQuery is required for this example. -->
    <script src='https://code.jquery.com/jquery-1.11.0.min.js'></script>

    <script>
        L.mapbox.accessToken = 'pk.eyJ1Ijoic2Fpa2lhLWFiaGlzaGVrOCIsImEiOiJhNTY1ZTBkZDYyMTlmMmRkY2E4OGM3ZTgzYjZkMjgzZSJ9.nwcECTyhbPI2gpOWXXvDAw';
        var map = L.mapbox.map('map', 'mapbox.streets')
            .setView([12.9667, 77.5667], 14).addControl(L.mapbox.geocoderControl('mapbox.places'));

        // Credit Zomato for their wonderful data
        map.attributionControl
            .addAttribution('<a href="https://www.mediawiki.org/">Lakes in Bangalore</a>');


        // Keep our place markers organized in a nice group.
        var WikiPlaces = L.layerGroup().addTo(map);

      // Use jQuery to make an AJAX request to Wikipedia to load markers data.

      function loadPoints() {
          var center = map.getCenter();
          console.log(center);
          var lat = center.lat;
          var lon = center.lng;

            var API_ENDPOINT = 'https://en.wikipedia.org/w/api.php?action=query&list=geosearch&gsradius=1000&gscoord='+lat+'|'+lon+'&format=json&gslimit=1000&callback=?';

        // body...
        $.getJSON(API_ENDPOINT, {
            // 'origin': 'http://localhost:3000'
          },
            function(result, status) {

            if (status !== 'success') return alert('Request to Wikipedia failed');
            console.log('result', result, status)
            // Transform each venue result into a marker on the map.
            for (var i = 0; i < result.query.geosearch.length; i++)
            {
              var obj = result.query.geosearch[i];
              console.log('obj', obj);
              var title = obj.title;
              var latlng = L.latLng(obj.lat, obj.lon);
              var marker = L.marker(latlng, {
                  icon: L.mapbox.marker.icon({
                    'marker-color': '#BE9A6B',
                    'marker-size': 'large'
                  })
                })
              .bindPopup('<strong>'+obj.title+'</strong>')
              .addTo(WikiPlaces);

            }
        });
      }

      map.on('move', function(e) {
        console.log('moving!');
        loadPoints();

      });

      loadPoints();
    </script>
  </body>
</html>







